<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor MatemÃ¡tico â€“ CLQ</title>
    <link rel="stylesheet" href="simulador.css">
    <!-- TipografÃ­a Poppins para el tutor -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="tutor-page">
    <!-- Barra de navegaciÃ³n principal -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-logo">
                <img src="assets/logos/clq-logo.png" alt="CLQ" class="logo-img">
                <span>CLQ</span>
            </div>
            <div class="navbar-links">
                <a href="index.html">Inicio</a>
                <a href="simulador.html">Simulador</a>
                <a href="tutor.html" class="active">Tutor</a>
                <a href="instrucciones.html">Instrucciones</a>
                <a href="nosotros.html">Nosotros</a>
                <a href="faq.html">Preguntas</a>
                <a href="contacto.html">Contacto</a>
            </div>
        </div>
    </nav>
    <header class="tutor-header">
        <div class="header-content">
            <div class="header-emoji" role="img" aria-label="Tutor">ðŸ¤–</div>
            <h1>Tutor MatemÃ¡tico CLQ</h1>
            <p>Plantea tu duda en lenguaje natural y recibe una explicaciÃ³n clara y completa.</p>
        </div>
    </header>
    <main class="tutor-container">
        <div id="chat" class="chat-window">
            <!-- Los mensajes se aÃ±adirÃ¡n aquÃ­ -->
        </div>
        <!-- BotÃ³n para limpiar la conversaciÃ³n -->
        <div class="chat-actions">
            <button id="clear-chat" class="btn secondary small" type="button">Limpiar conversaciÃ³n</button>
        </div>
        <form id="chat-form" class="chat-form" autocomplete="off">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta o problema..." required>
            <button type="submit" class="btn">Enviar</button>
        </form>
    </main>
    <!-- Script de tutor incorporado -->
    <script src="config.js"></script>
    <script>
    // MÃ³dulo de tutor. Si se dispone de clave OPENAI_API_KEY utilizarÃ¡ la API de ChatGPT.
    const chatWindow = document.getElementById('chat');
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');

    // Diccionario de temas con respuestas ejemplo y sugerencias de prÃ¡ctica
    const tutorTopics = {
        algebra: {
            /* Eliminamos la letra "x" de las palabras clave para evitar capturar consultas generales (como derivadas) */
            keywords: ['ecuaciÃ³n', 'Ã¡lgebra', 'variable'],
            response: 'Para resolver ecuaciones de primer grado, despeja la incÃ³gnita. Por ejemplo, en 2x + 3 = 9, resta 3 a ambos lados y luego divide por 2 para obtener x = 3.',
            practice: 'Resuelve: 3x - 5 = 10. Â¿CuÃ¡l es el valor de x?'
        },
        geometria: {
            keywords: ['triÃ¡ngulo', 'Ã¡ngulo', 'geometrÃ­a', 'perÃ­metro', 'Ã¡rea', 'rectÃ¡ngulo'],
            response: 'En geometrÃ­a, el perÃ­metro de un rectÃ¡ngulo se calcula sumando el doble de su ancho y largo. El Ã¡rea es ancho por largo. Si tienes un triÃ¡ngulo, recuerda que la suma de sus Ã¡ngulos internos es 180Â°.',
            practice: 'Calcula el Ã¡rea de un rectÃ¡ngulo de 5 cm de largo y 3 cm de ancho.'
        },
        funciones: {
            keywords: ['funciÃ³n', 'grÃ¡fica', 'pendiente', 'parÃ¡bola'],
            response: 'Una funciÃ³n lineal tiene la forma f(x) = mx + b donde m es la pendiente y b es la ordenada al origen. Para trazarla, ubica el punto (0, b) y a partir de ahÃ­ aplica la pendiente.',
            practice: 'Dibuja la grÃ¡fica de f(x) = 2x + 1 e indica su pendiente y su intercepto.'
        },
        probabilidad: {
            keywords: ['probabilidad', 'dados', 'azar', 'dados', 'evento'],
            response: 'La probabilidad de un evento es la razÃ³n entre casos favorables y casos posibles. Por ejemplo, al lanzar un dado justo, la probabilidad de obtener un 6 es 1/6.',
            practice: 'Si lanzas una moneda dos veces, Â¿cuÃ¡l es la probabilidad de obtener dos caras?'
        }
        , conjuntos: {
            keywords: ['conjunto', 'intersecciÃ³n', 'uniÃ³n', 'elemento'],
            response: 'Los conjuntos son colecciones de elementos bien definidos. La intersecciÃ³n A âˆ© B incluye solo los elementos que pertenecen a ambos conjuntos, mientras que la uniÃ³n A âˆª B combina todos los elementos de ambos conjuntos.',
            practice: 'Dados los conjuntos A = {1,3,5} y B = {3,4,5}, calcula A âˆª B y A âˆ© B.'
        },
        datos: {
            keywords: ['media', 'mediana', 'moda', 'promedio', 'datos', 'estadÃ­stica'],
            response: 'En estadÃ­stica, la media se calcula sumando todos los datos y dividiendo por la cantidad de elementos. La mediana es el valor central al ordenar los datos y la moda es el valor que mÃ¡s se repite.',
            practice: 'Para el conjunto {2, 4, 4, 5, 6}, calcula la media, la mediana y la moda.'
        },
        calculo: {
            keywords: ['derivada', 'derivar', 'integral', 'integrar', 'lÃ­mite', 'cÃ¡lculo'],
            response: 'El cÃ¡lculo estudia conceptos como lÃ­mites, derivadas e integrales. La derivada mide la tasa de cambio instantÃ¡nea de una funciÃ³n, mientras que la integral calcula el Ã¡rea bajo una curva.',
            practice: 'Calcula la derivada de f(x) = x^3 + 2x y la integral de g(x) = 2x.'
        }
    };

    // Historial de conversaciÃ³n para ChatGPT
    const conversation = [
      { role: 'system', content: 'Eres un tutor de matemÃ¡ticas en espaÃ±ol. Responde de forma clara, paso a paso, con empatÃ­a y ejemplos.' }
    ];

    /**
     * Llama a la API de OpenAI para obtener una respuesta basada en el historial.
     * Requiere que OPENAI_API_KEY estÃ© definida en config.js.
     * @param {string} question
     */
    async function fetchGPTResponse(question) {
      // Agrega la pregunta del usuario al historial
      conversation.push({ role: 'user', content: question });
      try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${OPENAI_API_KEY}`
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: conversation
          })
        });
        if (!response.ok) {
          throw new Error('Error al comunicarse con OpenAI');
        }
        const data = await response.json();
        const answer = data.choices[0].message.content.trim();
        // Agrega la respuesta de la IA al historial
        conversation.push({ role: 'assistant', content: answer });
        return answer;
      } catch (err) {
        console.error(err);
        return null;
      }
    }

    // FunciÃ³n para aÃ±adir mensajes al chat
    function addMessage(text, sender) {
        const msg = document.createElement('div');
        msg.classList.add('message', sender);
        msg.textContent = text;
        chatWindow.appendChild(msg);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // FunciÃ³n para procesar la entrada del usuario
    async function processInput(input) {
        const lower = input.toLowerCase();
        // Si hay una clave API, intentar con ChatGPT
        if (typeof OPENAI_API_KEY === 'string' && OPENAI_API_KEY.trim() !== '') {
            const aiAnswer = await fetchGPTResponse(input);
            if (aiAnswer) {
                return aiAnswer;
            }
        }
        // Manejo especÃ­fico: calcular derivadas simples de polinomios de x
        // Si la consulta menciona "derivada" y contiene al menos una 'x', intentamos parsear una expresiÃ³n
        if (lower.includes('derivada') && lower.includes('x')) {
            const exprMatch = input.match(/derivada(?: de)?\s*(.*)/i);
            if (exprMatch && exprMatch[1]) {
                // Extraer la expresiÃ³n despuÃ©s de "derivada de"
                let expr = exprMatch[1];
                // Si la expresiÃ³n contiene un sÃ­mbolo '=' (por ejemplo f(x) = x^2), tomar la parte a la derecha
                if (expr.includes('=')) {
                    const parts = expr.split('=');
                    expr = parts[1];
                }
                // FunciÃ³n auxiliar para calcular derivadas de polinomios sencillos
                function computeDerivative(expression) {
                    let clean = expression.replace(/\s+/g, '');
                    // Dividir la expresiÃ³n en tÃ©rminos considerando signos
                    const terms = clean.match(/[+-]?[^+-]+/g);
                    if (!terms) return null;
                    const derivativeTerms = [];
                    for (let term of terms) {
                        if (term === '') continue;
                        // Determinar el signo del tÃ©rmino
                        let sign = 1;
                        if (term.startsWith('-')) {
                            sign = -1;
                            term = term.slice(1);
                        } else if (term.startsWith('+')) {
                            term = term.slice(1);
                        }
                        // Si el tÃ©rmino contiene 'x'
                        if (term.includes('x')) {
                            // Obtener coeficiente (si existe)
                            let coefficient = 1;
                            const coefMatch = term.match(/^[0-9]+/);
                            if (coefMatch) {
                                coefficient = parseInt(coefMatch[0], 10);
                                term = term.slice(coefMatch[0].length);
                            }
                            // Obtener exponente
                            let exponent = 1;
                            const expMatch = term.match(/\^([0-9]+)/);
                            if (expMatch) {
                                exponent = parseInt(expMatch[1], 10);
                            }
                            // Calcular derivada del tÃ©rmino: coeficiente * exponente
                            const newCoeff = sign * coefficient * exponent;
                            const newExponent = exponent - 1;
                            if (newCoeff === 0) continue;
                            if (newExponent === 0) {
                                derivativeTerms.push(`${newCoeff}`);
                            } else if (newExponent === 1) {
                                derivativeTerms.push(`${newCoeff}x`);
                            } else {
                                derivativeTerms.push(`${newCoeff}x^${newExponent}`);
                            }
                        }
                        // Terminos constantes se ignoran porque su derivada es 0
                    }
                    if (derivativeTerms.length === 0) return null;
                    // Unir los tÃ©rminos con el signo correcto
                    return derivativeTerms.map((t, index) => {
                        if (index === 0) return t;
                        // AÃ±adir signo explÃ­cito si el tÃ©rmino empieza con un negativo
                        return t.startsWith('-') ? ` ${t}` : ` + ${t}`;
                    }).join('');
                }
                const derivative = computeDerivative(expr);
                if (derivative) {
                    return `La derivada de ${expr.trim()} es: ${derivative}.`;
                }
            }
        }
        // En caso contrario, buscar coincidencias en los temas predefinidos
        for (const topic in tutorTopics) {
            const { keywords, response, practice } = tutorTopics[topic];
            if (keywords.some(k => lower.includes(k))) {
                return `${response}\n\nEjercicio propuesto: ${practice}`;
            }
        }
        // Respuesta predeterminada
        return 'Lo siento, no logro identificar el tema especÃ­fico de tu consulta. Intenta formular tu duda indicando el concepto (ejemplo: ecuaciones, triÃ¡ngulos, funciones).';
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = userInput.value.trim();
        if (!question) return;
        addMessage(question, 'user');
        const answer = await processInput(question);
        setTimeout(() => {
            addMessage(answer, 'bot');
        }, 400);
        userInput.value = '';
    });

    // Limpia la conversaciÃ³n al pulsar el botÃ³n correspondiente
    const clearBtn = document.getElementById('clear-chat');
    clearBtn.addEventListener('click', () => {
        chatWindow.innerHTML = '';
        userInput.value = '';
    });
    </script>

    <!-- BotÃ³n volver arriba -->
    <button id="to-top" aria-label="Volver arriba">â†‘</button>

    <!-- Pie de pÃ¡gina -->
    <footer class="footer">
        <p>&copy; 2025 CLQ. Construido con compromiso y pasiÃ³n educativa. <br>
        Â¿Tienes preguntas? <a href="mailto:info@clq.com" style="color: #ffffff; text-decoration: underline;">ContÃ¡ctanos</a></p>
    </footer>

    <!-- Script para mostrar/ocultar botÃ³n volver arriba -->
    <script>
    const toTopBtn = document.getElementById('to-top');
    window.addEventListener('scroll', () => {
        if (window.pageYOffset > 300) {
            toTopBtn.style.display = 'flex';
        } else {
            toTopBtn.style.display = 'none';
        }
    });
    toTopBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    </script>
</body>
</html>